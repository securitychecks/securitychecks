// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html

exports[`Golden: AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE > Snapshot Stability > should match artifact snapshot > membership-artifact 1`] = `
{
  "authzCalls": [],
  "cacheOperations": [
    {
      "callerFunction": "getMembership",
      "file": "cache.ts",
      "key": "[auth] \`membership:\${userId}:\${teamId}\`",
      "line": 12,
      "type": "get",
    },
    {
      "callerFunction": "validateApiKey",
      "file": "cache.ts",
      "key": "[auth] \`apikey:\${hashedSecret}\`",
      "line": 19,
      "type": "get",
    },
    {
      "callerFunction": "removeFromTeam",
      "file": "team-service.ts",
      "key": "[auth] \`membership:\${userId}:\${teamId}\`",
      "line": 32,
      "type": "delete",
    },
    {
      "callerFunction": "removeFromTeam",
      "file": "team-service.ts",
      "key": "[auth] \`user:\${userId}:teams\`",
      "line": 33,
      "type": "delete",
    },
    {
      "callerFunction": "deleteApiKey",
      "file": "team-service.ts",
      "key": "[auth] \`apikey:\${hashedSecret}\`",
      "line": 52,
      "type": "delete",
    },
  ],
  "callGraph": {
    "nodes": [
      {
        "calledBy": [
          {
            "callerFile": "cache.ts",
            "callerFunction": "getMembership",
          },
          {
            "callerFile": "cache.ts",
            "callerFunction": "validateApiKey",
          },
        ],
        "calls": [],
        "file": "cache.ts",
        "functionName": "get",
        "line": 5,
      },
      {
        "calls": [],
        "file": "cache.ts",
        "functionName": "set",
        "line": 6,
      },
      {
        "calledBy": [
          {
            "callerFile": "team-service.ts",
            "callerFunction": "removeFromTeam",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "deleteApiKey",
          },
        ],
        "calls": [],
        "file": "cache.ts",
        "functionName": "del",
        "line": 7,
      },
      {
        "calls": [
          {
            "line": 12,
            "targetFunction": "get",
          },
        ],
        "file": "cache.ts",
        "functionName": "getMembership",
        "line": 11,
      },
      {
        "calls": [
          {
            "line": 19,
            "targetFunction": "get",
          },
        ],
        "file": "cache.ts",
        "functionName": "validateApiKey",
        "line": 18,
      },
      {
        "calledBy": [
          {
            "callerFile": "team-service.ts",
            "callerFunction": "removeMember",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "removeFromTeam",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "deleteApiKey",
          },
        ],
        "calls": [],
        "file": "db.ts",
        "functionName": "delete",
        "line": 6,
      },
      {
        "calledBy": [
          {
            "callerFile": "team-service.ts",
            "callerFunction": "downgradeRole",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "revokeApiKey",
          },
        ],
        "calls": [],
        "file": "db.ts",
        "functionName": "update",
        "line": 7,
      },
      {
        "calledBy": [
          {
            "callerFile": "team-service.ts",
            "callerFunction": "downgradeRole",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "revokeApiKey",
          },
        ],
        "calls": [],
        "file": "db.ts",
        "functionName": "update",
        "line": 10,
      },
      {
        "calledBy": [
          {
            "callerFile": "team-service.ts",
            "callerFunction": "removeMember",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "removeFromTeam",
          },
          {
            "callerFile": "team-service.ts",
            "callerFunction": "deleteApiKey",
          },
        ],
        "calls": [],
        "file": "db.ts",
        "functionName": "delete",
        "line": 11,
      },
      {
        "calls": [
          {
            "line": 10,
            "targetFunction": "delete",
          },
        ],
        "file": "team-service.ts",
        "functionName": "removeMember",
        "line": 9,
      },
      {
        "calls": [
          {
            "line": 18,
            "targetFunction": "update",
          },
        ],
        "file": "team-service.ts",
        "functionName": "downgradeRole",
        "line": 17,
      },
      {
        "calls": [
          {
            "line": 27,
            "targetFunction": "delete",
          },
          {
            "line": 32,
            "targetFunction": "del",
          },
        ],
        "file": "team-service.ts",
        "functionName": "removeFromTeam",
        "line": 26,
      },
      {
        "calls": [
          {
            "line": 38,
            "targetFunction": "update",
          },
        ],
        "file": "team-service.ts",
        "functionName": "revokeApiKey",
        "line": 37,
      },
      {
        "calls": [
          {
            "line": 47,
            "targetFunction": "delete",
          },
          {
            "line": 52,
            "targetFunction": "del",
          },
        ],
        "file": "team-service.ts",
        "functionName": "deleteApiKey",
        "line": 46,
      },
    ],
  },
  "codebase": {
    "filesScanned": 1,
    "frameworkVersions": {},
    "frameworks": [],
    "languages": [
      "typescript",
    ],
    "partitions": [
      {
        "effectiveFrameworks": [],
        "frameworkVersions": {},
        "frameworks": [],
        "kind": "root",
        "relativePath": "",
      },
    ],
    "root": "/normalized/path",
  },
  "dataFlows": {
    "flows": [],
    "sinks": [
      {
        "context": "Prisma delete",
        "file": "team-service.ts",
        "functionContext": "removeMember",
        "line": 10,
        "taintedInputs": [
          "db",
          "teamMember",
          "delete",
          "where",
          "userId_teamId",
          "userId",
          "teamId",
        ],
        "type": "database_write",
      },
      {
        "context": "Prisma update",
        "file": "team-service.ts",
        "functionContext": "downgradeRole",
        "line": 18,
        "taintedInputs": [
          "db",
          "teamMember",
          "update",
          "where",
          "userId_teamId",
          "userId",
          "teamId",
          "data",
          "role",
          "newRole",
        ],
        "type": "database_write",
      },
      {
        "context": "Prisma delete",
        "file": "team-service.ts",
        "functionContext": "removeFromTeam",
        "line": 27,
        "taintedInputs": [
          "db",
          "teamMember",
          "delete",
          "where",
          "userId_teamId",
          "userId",
          "teamId",
        ],
        "type": "database_write",
      },
      {
        "context": "Prisma update",
        "file": "team-service.ts",
        "functionContext": "revokeApiKey",
        "line": 38,
        "taintedInputs": [
          "db",
          "apiKey",
          "update",
          "where",
          "id",
          "keyId",
          "data",
          "revokedAt",
        ],
        "type": "database_write",
      },
      {
        "context": "Prisma delete",
        "file": "team-service.ts",
        "functionContext": "deleteApiKey",
        "line": 47,
        "taintedInputs": [
          "db",
          "apiKey",
          "delete",
          "where",
          "id",
          "keyId",
        ],
        "type": "database_write",
      },
    ],
    "sources": [],
    "transforms": [],
  },
  "extractedAt": "2024-01-01T00:00:00.000Z",
  "jobHandlers": [],
  "membershipMutations": [
    {
      "confidence": "high",
      "entity": "member",
      "file": "team-service.ts",
      "functionName": "removeMember",
      "hasCacheInvalidation": false,
      "invalidationLocation": undefined,
      "line": 9,
      "mutationType": "remove",
      "relatedCacheKeys": undefined,
      "signals": [
        "name:removeMember",
        "pattern:remove.*member",
        "param:userId",
        "param:teamId",
        "db:delete",
        "db:teamMember",
        "cache:none",
      ],
    },
    {
      "confidence": "high",
      "entity": "role",
      "file": "team-service.ts",
      "functionName": "downgradeRole",
      "hasCacheInvalidation": false,
      "invalidationLocation": undefined,
      "line": 17,
      "mutationType": "downgrade",
      "relatedCacheKeys": undefined,
      "signals": [
        "name:downgradeRole",
        "pattern:downgrade.*role",
        "param:userId",
        "param:teamId",
        "db:update",
        "db:teamMember",
        "db:role",
        "cache:none",
      ],
    },
    {
      "confidence": "high",
      "entity": "team",
      "file": "team-service.ts",
      "functionName": "removeFromTeam",
      "hasCacheInvalidation": true,
      "invalidationLocation": "cache.del",
      "line": 26,
      "mutationType": "remove",
      "relatedCacheKeys": [
        "\`membership:\${userId}:\${teamId}\`",
        "\`membership:\${userId}:\${teamId}\`",
        "\`membership:\${userId}:\${teamId}\`",
        "\`user:\${userId}:teams\`",
      ],
      "signals": [
        "name:removeFromTeam",
        "pattern:removeFromTeam",
        "param:userId",
        "param:teamId",
        "db:delete",
        "db:teamMember",
        "db:membership",
        "cache:invalidation:cache.del",
        "cache:key:member",
        "cache:key:membership",
        "cache:key:team",
      ],
    },
    {
      "confidence": "high",
      "entity": "apiKey",
      "file": "team-service.ts",
      "functionName": "revokeApiKey",
      "hasCacheInvalidation": false,
      "invalidationLocation": undefined,
      "line": 37,
      "mutationType": "revoke",
      "relatedCacheKeys": undefined,
      "signals": [
        "name:revokeApiKey",
        "pattern:revokeApiKey",
        "param:keyId",
        "param:apiKey",
        "db:update",
        "db:apiKey",
        "cache:none",
      ],
    },
    {
      "confidence": "high",
      "entity": "apiKey",
      "file": "team-service.ts",
      "functionName": "deleteApiKey",
      "hasCacheInvalidation": true,
      "invalidationLocation": "cache.del",
      "line": 46,
      "mutationType": "remove",
      "relatedCacheKeys": [
        "\`apikey:\${hashedSecret}\`",
      ],
      "signals": [
        "name:deleteApiKey",
        "pattern:deleteApiKey",
        "param:keyId",
        "param:apiKey",
        "db:delete",
        "db:apiKey",
        "cache:invalidation:cache.del",
        "cache:key:apiKey",
      ],
    },
  ],
  "profile": "securitychecks",
  "rlsArtifact": {
    "framework": "unknown",
    "hasRLSContextHelper": false,
    "multiTenantTables": [],
    "queries": [
      {
        "containingFunction": "removeMember",
        "file": "team-service.ts",
        "framework": "prisma",
        "hasTenantFilter": true,
        "line": 10,
        "operation": "delete",
        "table": "teamMember",
        "tenantFilterExpression": "teamId: { userId",
      },
      {
        "containingFunction": "downgradeRole",
        "file": "team-service.ts",
        "framework": "prisma",
        "hasTenantFilter": true,
        "line": 18,
        "operation": "update",
        "table": "teamMember",
        "tenantFilterExpression": "teamId: { userId",
      },
      {
        "containingFunction": "removeFromTeam",
        "file": "team-service.ts",
        "framework": "prisma",
        "hasTenantFilter": true,
        "line": 27,
        "operation": "delete",
        "table": "teamMember",
        "tenantFilterExpression": "teamId: { userId",
      },
      {
        "containingFunction": "revokeApiKey",
        "file": "team-service.ts",
        "framework": "prisma",
        "hasTenantFilter": true,
        "line": 38,
        "operation": "update",
        "table": "apiKey",
        "tenantFilterExpression": undefined,
      },
      {
        "containingFunction": "deleteApiKey",
        "file": "team-service.ts",
        "framework": "prisma",
        "hasTenantFilter": true,
        "line": 47,
        "operation": "delete",
        "table": "apiKey",
        "tenantFilterExpression": undefined,
      },
    ],
    "rlsPolicies": [],
    "usesSupabase": false,
  },
  "routes": [],
  "schemaVersion": "1.3.0",
  "services": [
    {
      "exportedFunctions": [
        "removeMember",
        "downgradeRole",
        "removeFromTeam",
        "revokeApiKey",
        "deleteApiKey",
      ],
      "file": "team-service.ts",
      "line": 1,
      "name": "team-service",
    },
  ],
  "tests": [],
  "transactionScopes": [],
  "version": "1.0",
  "webhookHandlers": [],
}
`;

exports[`Golden: AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE > Snapshot Stability > should match findings snapshot > membership-findings 1`] = `
[
  {
    "hasRemediation": true,
    "hasStructuredEvidence": true,
    "invariantId": "AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE",
    "severity": "P0",
    "structuredConfidence": "high",
    "symbol": "removeMember",
  },
  {
    "hasRemediation": true,
    "hasStructuredEvidence": true,
    "invariantId": "AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE",
    "severity": "P0",
    "structuredConfidence": "high",
    "symbol": "downgradeRole",
  },
  {
    "hasRemediation": true,
    "hasStructuredEvidence": true,
    "invariantId": "AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE",
    "severity": "P1",
    "structuredConfidence": "high",
    "symbol": "removeFromTeam",
  },
]
`;

exports[`Golden: AUTHZ.MEMBERSHIP.REVOCATION.IMMEDIATE > Snapshot Stability > should match membership mutations snapshot > membership-mutations 1`] = `
[
  {
    "confidence": "high",
    "entity": "member",
    "file": "team-service.ts",
    "functionName": "removeMember",
    "hasCacheInvalidation": false,
    "hasInvalidationLocation": false,
    "line": 9,
    "mutationType": "remove",
    "signalCount": 7,
  },
  {
    "confidence": "high",
    "entity": "role",
    "file": "team-service.ts",
    "functionName": "downgradeRole",
    "hasCacheInvalidation": false,
    "hasInvalidationLocation": false,
    "line": 17,
    "mutationType": "downgrade",
    "signalCount": 8,
  },
  {
    "confidence": "high",
    "entity": "team",
    "file": "team-service.ts",
    "functionName": "removeFromTeam",
    "hasCacheInvalidation": true,
    "hasInvalidationLocation": true,
    "line": 26,
    "mutationType": "remove",
    "signalCount": 11,
  },
  {
    "confidence": "high",
    "entity": "apiKey",
    "file": "team-service.ts",
    "functionName": "revokeApiKey",
    "hasCacheInvalidation": false,
    "hasInvalidationLocation": false,
    "line": 37,
    "mutationType": "revoke",
    "signalCount": 7,
  },
  {
    "confidence": "high",
    "entity": "apiKey",
    "file": "team-service.ts",
    "functionName": "deleteApiKey",
    "hasCacheInvalidation": true,
    "hasInvalidationLocation": true,
    "line": 46,
    "mutationType": "remove",
    "signalCount": 8,
  },
]
`;
